#!/bin/bash
# shellcheck source=/dev/null

########################
#                      #
# CUSTOM BASH COMMANDS #
#                      #
########################

source ~/.fancy-bash.sh
source ~/.aliases.sh

function trimBranchName {
  local branchName="$1"
  local branchNameLength=${#branchName}
  local maxBranchNameLength=20
  local trimmedBranchName="$branchName"

  if (( branchNameLength > maxBranchNameLength )); then
    local trimmedBranchName="${branchName:0:maxBranchNameLength-3}..."
  fi

  echo "$trimmedBranchName"
}


# from James
function join_array { local IFS="$1"; shift; echo "$*"; }

# from James
function ellipsedPath {
  local w=""
  local paths=""
  OIFS="$IFS"
  IFS=" "
  read -r -a paths <<< "$(echo "$PWD" | tr "/" " ")"

  wai=$(whoami)
  if [ "${paths[0]}" == "home" ] && [ "${paths[1]}" == "${wai}" ]; then
    w='~'
    read -r -a paths <<< "${paths[*]:2}"
  else
    w="/${paths[0]}"
    read -r -a paths <<< "${paths[*]:1}"
  fi;

  if (( ${#paths[@]} >= 3 )); then
    w="$w/..."
    read -r -a paths <<< "${paths[@]: -2}"
  fi;

  w=$(join_array '/' "$w" "${paths[@]}")
  IFS="$OIFS"

  echo "$w"
}

# export PROMPT_DIRTRIM=2
# PROMPT_COMMAND='PS1="${HOTPINK}\u${NONE} :: ${ITALICS}$(ellipsedPath)${NONE} "
# PSI: ${BLUE}${BOLD} $>${NONE} "'

COLOR=""
BRANCH=""
STATE=""
REMOTE=""

# derived from https://gist.github.com/alampros/1035915
# refactor color & state into a function
function parse_git_for_variables {
	git rev-parse --git-dir &> /dev/null
	git_status="$(git status 2> /dev/null)"
  clean_pattern="working tree clean"
	branch_pattern="^On branch ([^${IFS}]*)"
	remote_pattern="Your branch is (.*) of"
	diverge_pattern="Your branch and (.*) have diverged"
  dirty_pattern="not staged for commit"

	if [[ ${git_status} =~ ${clean_pattern} ]];
  then
    COLOR="${GREEN}"
		STATE="${CHECK_MARK}"
	fi

  if [[ ${git_status} =~ ${dirty_pattern} ]];
  then
    COLOR="${YELLOW}"
    STATE="${YELLOW}${WARNING_SIGN}${NONE}"
  fi

	if [[ ${git_status} =~ ${remote_pattern} ]];
  then
		if [[ ${BASH_REMATCH[1]} == "ahead" ]];
    then
			REMOTE="${GREEN}${ARROW_UP}${NONE}"
		else
			REMOTE="${YELLOW}${ARROW_DOWN}${NONE}"
		fi
	fi

	if [[ ${git_status} =~ ${diverge_pattern} ]];
  then
		REMOTE="${YELLOW}${ARROW_UP_DOWN}${NONE}"
	fi

  # better git/branch symbol? http://www.whiteboardcoder.com/2016/03/sbt-customize-shell-prompt-with-git.html
	if [[ ${git_status} =~ ${branch_pattern} ]];
  then
		BRANCH=${BASH_REMATCH[1]}
    GIT_INFO="(${COLOR}${REMOTE} ${STATE}${NONE} )"
    PSI="${BLUE}${BOLD}${NEPTUNE} >${NONE} "
  else
    BRANCH=""
    PSI="${BLUE}${BOLD}$ >${NONE} "
	fi
}

# derived from https://gist.github.com/alampros/1035915
function prompt_func() {
  parse_git_for_variables

  prompt="${HOTPINK}\\u${NONE} :: ${ITALICS}$(ellipsedPath)${NONE}"

  if [ -z "$BRANCH" ];
  then
    PS1="${prompt} ${PSI}"
  else
    PS1="${prompt} $(echo -e "${GIT_INFO}") \n $(trimBranchName "$BRANCH") $(echo -e "${PSI}")"
  fi
}

PROMPT_COMMAND=prompt_func

export SUDO_EDITOR="/usr/bin/gedit"

# set PATH so it includes user's private bin directories
PATH=$PATH:$HOME/bin:$HOME/.local/bin:$HOME/.local/scripts
